<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>UbicaciÃ³n en tiempo real + Geocerca</title>

  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">

  <style>
    body {
      margin: 0;
      font-family: "Poppins", Arial, sans-serif;
      background: #eef3f8;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    h1 {
      background: linear-gradient(135deg, #0078A8, #00A8A8);
      color: white;
      padding: 15px;
      width: 100%;
      margin: 0;
      text-align: center;
    }

    #map {
      width: 90%;
      height: 500px;
      margin: 20px auto;
      border-radius: 15px;
      border: 3px solid #0078A8;
    }

    #info, #geofence-controls {
      background: white;
      width: 90%;
      max-width: 600px;
      padding: 20px;
      border-radius: 15px;
      margin-bottom: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.15);
    }

    button {
      padding: 10px 15px;
      background: #0078A8;
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      margin-top: 5px;
    }
  </style>
</head>

<body>

<h1>UbicaciÃ³n en tiempo real + Geocerca</h1>

<div id="map"></div>

<div id="geofence-controls">
  <h3>Geocerca</h3>
  <p>Haz clic en el mapa para definir el centro.</p>

  <label>Radio (metros):</label>
  <input type="number" id="radiusInput" value="150" min="10" max="5000">

  <button id="setGeofence">Crear Geocerca</button>

  <button id="enableSound">ðŸ”Š Activar sonido</button>
</div>

<div id="info">
  <p><strong>ID:</strong> <span id="id">--</span></p>
  <p><strong>Latitud:</strong> <span id="lat">--</span></p>
  <p><strong>Longitud:</strong> <span id="lon">--</span></p>
  <p><strong>Estado Geocerca:</strong> <span id="geoStatus">--</span></p>
</div>

<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
  import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js";

  // -------------------------
  // FIREBASE CONFIG
  // -------------------------
  const firebaseConfig = {
    apiKey: "AIzaSyCXn-GQ4K2gqaLwpMrtK_tSDDII204X9Hk",
    authDomain: "mapa-684b4.firebaseapp.com",
    projectId: "mapa-684b4",
    storageBucket: "mapa-684b4.firebasestorage.app",
    messagingSenderId: "1022457464337",
    appId: "1:1022457464337:web:4d3fc37564881207bb53b0",
    measurementId: "G-WEQ9JLK1L8"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // -------------------------
  // MAPA
  // -------------------------
  mapboxgl.accessToken = "pk.eyJ1IjoiamVzc2ljYWxhZnVlbnRlbCIsImEiOiJjbWhseHVndWQyOG1nMm1xMW1kMDZzNHdhIn0.tSJ9wotbIUT-r372rOWt2A";

  const map = new mapboxgl.Map({
    container: "map",
    style: "mapbox://styles/mapbox/streets-v11",
    center: [-68.1193, -16.5000],
    zoom: 14
  });

  map.addControl(new mapboxgl.NavigationControl());

  let marker = null;

  // -------------------------
  // AUDIO â€” SONIDO LARGO Y FUERTE
  // -------------------------
  let alertAudio = new Audio("https://actions.google.com/sounds/v1/alarms/digital_watch_alarm_long.ogg");
  alertAudio.volume = 1.0;

  let soundEnabled = false;

  document.getElementById("enableSound").onclick = () => {
    soundEnabled = true;
    alert("ðŸ”Š Sonido activado correctamente");
  };

  // funciÃ³n segura para reproducir sonido
  function playAlertSound() {
    if (!soundEnabled) return;
    const sound = alertAudio.cloneNode(true); // evita bloqueo
    sound.play().catch(() => {});
  }

  // -------------------------
  // GEOCERCA
  // -------------------------
  let geofence = null;
  let insideGeofence = null;

  map.on("click", (e) => {
    const center = [e.lngLat.lng, e.lngLat.lat];
    const radius = parseInt(document.getElementById("radiusInput").value);

    geofence = { center, radius };
    drawGeofence(center, radius);
  });

  document.getElementById("setGeofence").onclick = () => {
    alert("Haz clic en el mapa para colocar el centro de la geocerca");
  };

  function drawGeofence(center, radius) {
    const circle = createGeoJSONCircle(center, radius);

    if (map.getSource("geofence")) {
      map.getSource("geofence").setData(circle);
    } else {
      map.addSource("geofence", {
        type: "geojson",
        data: circle
      });

      map.addLayer({
        id: "geofence-layer",
        type: "fill",
        source: "geofence",
        paint: {
          "fill-color": "#00A8A8",
          "fill-opacity": 0.25
        }
      });
    }
  }

  // CÃ­rculo geogrÃ¡fico
  function createGeoJSONCircle(center, radiusInMeters) {
    const points = 64;
    const coords = { latitude: center[1], longitude: center[0] };
    const km = radiusInMeters / 1000;

    const ret = [];
    for (let i = 0; i < points; i++) {
      const angle = (i * 360) / points;
      const dx = km * Math.cos(angle * Math.PI / 180);
      const dy = km * Math.sin(angle * Math.PI / 180);

      const lng = coords.longitude + (dx / Math.cos(coords.latitude * Math.PI / 180)) / 111;
      const lat = coords.latitude + dy / 111;

      ret.push([lng, lat]);
    }
    ret.push(ret[0]);
    return {
      type: "FeatureCollection",
      features: [{
        type: "Feature",
        geometry: {
          type: "Polygon",
          coordinates: [ret]
        }
      }]
    };
  }

  // -------------------------
  // UBICACIÃ“N EN TIEMPO REAL
  // -------------------------
  const deviceId = "76e78ee43d8252b4";
  const ubicacionRef = ref(db, `Ubicaciones/${deviceId}`);

  onValue(ubicacionRef, (snapshot) => {
    const data = snapshot.val();
    if (!data) return;

    const lat = parseFloat(data.latitud);
    const lon = parseFloat(data.longitud);

    if (!marker) {
      marker = new mapboxgl.Marker({ color: "red" }).setLngLat([lon, lat]).addTo(map);
    } else {
      marker.setLngLat([lon, lat]);
    }

    document.getElementById("id").textContent = data.idDispositivo || "Desconocido";
    document.getElementById("lat").textContent = lat.toFixed(5);
    document.getElementById("lon").textContent = lon.toFixed(5);

    checkGeofence(lat, lon);
  });

  // -------------------------
  // COMPROBAR GEOCERCA
  // -------------------------
  function checkGeofence(lat, lon) {
    if (!geofence) return;

    const distance = getDistance(lat, lon, geofence.center[1], geofence.center[0]);
    const isInside = distance <= geofence.radius;

    if (insideGeofence === null) insideGeofence = isInside;

    // ENTRÃ“ A LA GEOCERCA
    if (isInside && insideGeofence === false) {
      document.getElementById("geoStatus").textContent = "EntrÃ³ a la geocerca";
      playAlertSound();
      insideGeofence = true;
    }

    // SALIÃ“ DE LA GEOCERCA
    if (!isInside && insideGeofence === true) {
      document.getElementById("geoStatus").textContent = "SaliÃ³ de la geocerca";
      playAlertSound();  // ahora sÃ­ suena siempre
      insideGeofence = false;
    }
  }

  function getDistance(lat1, lon1, lat2, lon2) {
    const R = 6371000;
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;

    const a =
      Math.sin(dLat / 2) ** 2 +
      Math.cos(lat1 * Math.PI / 180) *
      Math.cos(lat2 * Math.PI / 180) *
      Math.sin(dLon / 2) ** 2;

    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  }
</script>

</body>
</html>
