<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mapa en Tiempo Real</title>

  <link href="https://cdn.jsdelivr.net/npm/ol@7.3.0/ol.css" rel="stylesheet">

  <style>
    body { margin: 0; font-family: Arial, sans-serif; }
    #map { width: 100%; height: 80vh; }
    #panel {
      padding: 10px;
      background: #f8f9fa;
      box-shadow: 0 0 5px rgba(0,0,0,0.2);
      display: flex;
      justify-content: space-around;
      align-items: center;
      height: 20vh;
    }
    #panel div { text-align: center; }
    #alert { color: red; font-weight: bold; }
  </style>
</head>
<body>

<div id="map"></div>

<div id="panel">
  <div>Latitud: <span id="lat">0</span></div>
  <div>Longitud: <span id="lng">0</span></div>
  <div>Distancia: <span id="distance">0</span> m</div>
  <div id="alert"></div>
</div>

<audio id="alertSound" src="https://www.soundjay.com/button/beep-07.mp3" preload="auto"></audio>

<!-- OpenLayers -->
<script src="https://cdn.jsdelivr.net/npm/ol@7.3.0/dist/ol.js"></script>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
window.onload = function() {

  // ----------------- FIREBASE CONFIG -----------------
  const firebaseConfig = {
    apiKey: "TU_API_KEY",
    authDomain: "TU_PROJECT_ID.firebaseapp.com",
    projectId: "TU_PROJECT_ID",
    storageBucket: "TU_PROJECT_ID.appspot.com",
    messagingSenderId: "TU_SENDER_ID",
    appId: "TU_APP_ID"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // ----------------- DEVICE CONFIG -----------------
  const deviceId = "c02662f7eceb5744";  // ESTE ES EL DOCUMENTO EN FIRESTORE

  // Coordenadas de geocerca (LONGITUD, LATITUD)
  const geofenceCenter = [-68.125310, -16.487357];
  const geofenceRadius = 35; // metros

  const alertSound = document.getElementById("alertSound");

  // ----------------- MAPA -----------------
  const map = new ol.Map({
    target: "map",
    layers: [
      new ol.layer.Tile({ source: new ol.source.OSM() })
    ],
    view: new ol.View({
      center: ol.proj.fromLonLat(geofenceCenter),
      zoom: 16
    })
  });

  // Marcador del dispositivo
  const deviceFeature = new ol.Feature({
    geometry: new ol.geom.Point(ol.proj.fromLonLat(geofenceCenter))
  });

  deviceFeature.setStyle(new ol.style.Style({
    image: new ol.style.Circle({
      radius: 8,
      fill: new ol.style.Fill({ color: "blue" }),
      stroke: new ol.style.Stroke({ color: "white", width: 2 })
    })
  }));

  const vectorLayer = new ol.layer.Vector({
    source: new ol.source.Vector({ features: [deviceFeature] })
  });

  map.addLayer(vectorLayer);

  // Geocerca
  const geofenceCircle = new ol.Feature({
    geometry: new ol.geom.Circle(
      ol.proj.fromLonLat(geofenceCenter),
      geofenceRadius
    )
  });

  const geofenceLayer = new ol.layer.Vector({
    source: new ol.source.Vector({ features: [geofenceCircle] }),
    style: new ol.style.Style({
      stroke: new ol.style.Stroke({ color: "red", width: 2 }),
      fill: new ol.style.Fill({ color: "rgba(255,0,0,0.1)" })
    })
  });

  map.addLayer(geofenceLayer);

  setTimeout(() => map.updateSize(), 100);

  // ----------------- FUNCIONES -----------------
  function toRad(v) { return v * Math.PI / 180; }

  function distanceBetween(lat1, lon1, lat2, lon2) {
    const R = 6371000;
    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);
    const a = Math.sin(dLat/2)**2 +
              Math.cos(toRad(lat1)) *
              Math.cos(toRad(lat2)) *
              Math.sin(dLon/2)**2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  }

  let alertActive = false;

  function updateDevice(lat, lng) {
    const coords = ol.proj.fromLonLat([lng, lat]);
    deviceFeature.getGeometry().setCoordinates(coords);

    document.getElementById("lat").textContent = lat.toFixed(6);
    document.getElementById("lng").textContent = lng.toFixed(6);

    const dist = distanceBetween(lat, lng, geofenceCenter[1], geofenceCenter[0]);
    document.getElementById("distance").textContent = dist.toFixed(1);

    if (dist <= geofenceRadius) {
      document.getElementById("alert").textContent = "⚠ Dentro de la geocerca";
      if (!alertActive) {
        alertSound.play();
        alertActive = true;
      }
    } else {
      document.getElementById("alert").textContent = "";
      alertActive = false;
    }
  }

  // ----------------- LECTURA FIRESTORE TIEMPO REAL -----------------
  db.collection("ubicaciones").doc(deviceId)
    .onSnapshot((doc) => {
      if (doc.exists) {
        const data = doc.data();

        // Firestore campos: latitude / longitude (según tu captura)
        const lat = data.latitude;
        const lng = data.longitude;

        if (lat && lng) {
          updateDevice(lat, lng);
        }
      }
    });

};
</script>

</body>
</html>
