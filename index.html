<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ubicación en tiempo real - Firebase + Mapbox</title>

  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">

  <style>
    body {
      margin: 0;
      font-family: "Poppins", Arial, sans-serif;
      background: #eef3f8;
      color: #333;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    h1 {
      background: linear-gradient(135deg, #0078A8, #00A8A8);
      color: white;
      padding: 15px 10px;
      margin: 0;
      width: 100%;
      text-shadow: 0 2px 4px rgba(0,0,0,0.2);
      font-size: 1.5em;
      letter-spacing: 1px;
      text-align: center;
    }

    #crearGeocercaBtn {
      margin-top: 10px;
      padding: 10px 20px;
      font-size: 16px;
      background: #0078A8;
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
    }

    #map {
      width: 90%;
      height: 500px;
      margin: 25px auto;
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      border: 3px solid #0078A8;
      transition: transform 0.3s ease;
    }

    #info {
      background: white;
      width: 85%;
      max-width: 600px;
      margin: 15px auto 30px;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.15);
      text-align: left;
    }

    #info p {
      margin: 10px 0;
      font-size: 1em;
      display: flex;
      justify-content: space-between;
      border-bottom: 1px solid #f0f0f0;
      padding-bottom: 6px;
    }

    #info strong {
      color: #0078A8;
    }
  </style>
</head>
<body>

<h1>Ubicación en tiempo real</h1>

<button id="crearGeocercaBtn">Crear geocerca</button>

<div id="map"></div>

<div id="info">
  <p><strong>ID:</strong> <span id="id">--</span></p>
  <p><strong>Latitud:</strong> <span id="lat">--</span></p>
  <p><strong>Longitud:</strong> <span id="lon">--</span></p>
  <p><strong>Geocerca:</strong> <span id="estadoGeocerca">--</span></p>
</div>

<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
  import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCXn-GQ4K2gqaLwpMrtK_tSDDII204X9Hk",
    authDomain: "mapa-684b4.firebaseapp.com",
    projectId: "mapa-684b4",
    storageBucket: "mapa-684b4.firebasestorage.app",
    messagingSenderId: "1022457464337",
    appId: "1:1022457464337:web:4d3fc37564881207bb53b0",
    measurementId: "G-WEQ9JLK1L8"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  mapboxgl.accessToken = 'pk.eyJ1IjoiamVzc2ljYWxhZnVlbnRlbCIsImEiOiJjbWhseHVndWQyOG1nMm1xMW1kMDZzNHdhIn0.tSJ9wotbIUT-r372rOWt2A';

  // ==== ALERTAS SONORAS Y NOTIFICACIONES =====
  const audioDentro = new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg");
  const audioFuera = new Audio("https://actions.google.com/sounds/v1/alarms/beep_alert.ogg");

  if (Notification.permission !== "granted") {
    Notification.requestPermission();
  }

  let ultimoEstado = null;

  // ==== INICIO MAPA =====
  window.onload = () => {
    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/streets-v11',
      center: [-68.1193, -16.5000],
      zoom: 13
    });

    map.addControl(new mapboxgl.NavigationControl());

    let marker = null;
    const deviceId = "76e78ee43d8252b4";
    const ubicacionRef = ref(db, `Ubicaciones/${deviceId}`);

    // ==== GEOCERCA ====
    let geofence = null;
    let geofenceCircle = null;
    let geofenceRadio = 300;
    let creandoGeocerca = false;

    document.getElementById("crearGeocercaBtn").onclick = () => {
      creandoGeocerca = true;
      alert("Haz clic en el mapa para elegir el centro de la geocerca.");
    };

    map.on("click", (e) => {
      if (!creandoGeocerca) return;

      const { lng, lat } = e.lngLat;

      geofence = { lat, lng, radio: geofenceRadio };

      if (geofenceCircle) {
        map.removeLayer("geofence-layer");
        map.removeSource("geofence-source");
      }

      const circle = generarCirculo([lng, lat], geofenceRadio);

      map.addSource("geofence-source", {
        "type": "geojson",
        "data": circle
      });

      map.addLayer({
        "id": "geofence-layer",
        "type": "fill",
        "source": "geofence-source",
        "paint": {
          "fill-color": "#0078A8",
          "fill-opacity": 0.3
        }
      });

      geofenceCircle = circle;
      creandoGeocerca = false;

      alert("Geocerca creada.");
    });

    function generarCirculo(center, radiusInMeters) {
      const points = 64;
      const coords = [];
      const distance = radiusInMeters / 6371000;

      for (let i = 0; i < points; i++) {
        const radians = i * (2 * Math.PI / points);
        const lat = Math.asin(
          Math.sin(center[1] * Math.PI / 180) * Math.cos(distance) +
          Math.cos(center[1] * Math.PI / 180) * Math.sin(distance) * Math.cos(radians)
        );
        const lon = center[0] * Math.PI / 180 + Math.atan2(
          Math.sin(radians) * Math.sin(distance) * Math.cos(center[1] * Math.PI / 180),
          Math.cos(distance) - Math.sin(center[1] * Math.PI / 180) * Math.sin(lat)
        );
        coords.push([lon * 180 / Math.PI, lat * 180 / Math.PI]);
      }

      coords.push(coords[0]);

      return {
        "type": "Feature",
        "geometry": {
          "type": "Polygon",
          "coordinates": [coords]
        }
      };
    }

    function calcularDistancia(lat1, lon1, lat2, lon2) {
      const R = 6371000;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;

      const a = Math.sin(dLat/2)**2 +
        Math.cos(lat1 * Math.PI / 180) *
        Math.cos(lat2 * Math.PI / 180) *
        Math.sin(dLon/2)**2;

      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    }

    // ==== MONITOREAR UBICACIÓN EN TIEMPO REAL ====
    onValue(ubicacionRef, (snapshot) => {
      const data = snapshot.val();
      if (!data) return;

      const lat = parseFloat(data.latitud);
      const lon = parseFloat(data.longitud);

      if (!isNaN(lat) && !isNaN(lon)) {

        if (!marker) {
          marker = new mapboxgl.Marker({ color: 'red' }).setLngLat([lon, lat]).addTo(map);
          map.setCenter([lon, lat]);
        } else {
          marker.setLngLat([lon, lat]);
        }

        document.getElementById("id").textContent = data.idDispositivo || "Desconocido";
        document.getElementById("lat").textContent = lat.toFixed(5);
        document.getElementById("lon").textContent = lon.toFixed(5);

        // ====== VERIFICAR GEOCERCA ======
        if (geofence) {
          const distancia = calcularDistancia(lat, lon, geofence.lat, geofence.lng);
          const estado = distancia <= geofence.radio ? "DENTRO" : "FUERA";

          document.getElementById("estadoGeocerca").textContent = estado;

          if (estado !== ultimoEstado) {

            // ENTRÓ
            if (estado === "DENTRO") {
              audioDentro.play();

              if (Notification.permission === "granted") {
                new Notification("Geocerca", {
                  body: "El dispositivo ENTRÓ a la geocerca.",
                  icon: "https://cdn-icons-png.flaticon.com/512/190/190411.png"
                });
              }

              alert("⚠ El dispositivo ENTRÓ a la geocerca.");
            }

            // SALIÓ
            else {
              audioFuera.play();

              if (Notification.permission === "granted") {
                new Notification("Geocerca", {
                  body: "El dispositivo SALIÓ de la geocerca.",
                  icon: "https://cdn-icons-png.flaticon.com/512/190/190406.png"
                });
              }

              alert("⚠ El dispositivo SALIÓ de la geocerca.");
            }

            ultimoEstado = estado;
          }
        }
      }
    });

  };
</script>

</body>
</html>
