<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PROYECTO GEOCERCAS ‚Äì JESSICA LAFUENTE</title>

  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">

  <style>
    body {
      margin: 0;
      font-family: "Segoe UI", Arial, sans-serif;
      background: #f0f0f8;
      text-align: center;
    }

    h1 {
      background: #6A00B9;
      color: white;
      padding: 15px;
      margin: 0;
      font-size: 28px;
      letter-spacing: 1px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.25);
    }

    #map {
      width: 90%;
      height: 500px;
      margin: 20px auto;
      border-radius: 12px;
      box-shadow: 0 4px 14px rgba(0,0,0,0.25);
    }

    #info {
      background: white;
      width: 80%;
      margin: 10px auto;
      padding: 12px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      font-size: 16px;
    }

    .card {
      background:white; 
      width:80%; 
      margin:20px auto; 
      padding:15px; 
      border-radius:12px; 
      box-shadow:0 3px 12px rgba(0,0,0,0.2);
      text-align:center;
    }

    #crear-geocerca {
      padding: 12px 28px;
      background:#6A00B9;
      color:white;
      border:none;
      border-radius:8px;
      cursor:pointer;
      font-size:17px;
      transition:0.25s;
    }

    #crear-geocerca:hover {
      background:#4a0080;
    }

    /* Notificaci√≥n */
    #noti {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #222;
      color: white;
      padding: 15px 20px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.35);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.5s, transform 0.5s;
      transform: translateY(-20px);
      z-index: 99999;
      font-size: 15px;
    }

    /* Estado */
    #estado {
      width: 230px;
      margin: 15px auto;
      padding: 12px;
      border-radius: 10px;
      font-size: 19px;
      font-weight: bold;
      background: #ddd;
    }

    .estado-verde { background:#d6ffcc; color:#0a6b14; }
    .estado-rojo { background:#ffd2d2; color:#8b0000; animation: vibrar 0.4s; }

    @keyframes vibrar {
      0% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      50% { transform: translateX(5px); }
      75% { transform: translateX(-5px); }
      100% { transform: translateX(0); }
    }
  </style>
</head>

<body>

  <h1>PROYECTO GEOCERCAS ‚Äì JESSICA LAFUENTE</h1>

  <div id="estado">üü° Esperando...</div>

  <div id="map"></div>

  <div id="info">
    <p><strong>ID:</strong> <span id="id">Esperando...</span></p>
    <p><strong>Latitud:</strong> <span id="lat">--</span></p>
    <p><strong>Longitud:</strong> <span id="lon">--</span></p>
    <p><strong>Hora:</strong> <span id="hora">--</span></p>
  </div>

  <!-- Tarjeta -->
  <div class="card">
    <h3>Nueva Geocerca</h3>

    <label>Radio (metros):</label>
    <input id="geo-rad" type="number" step="1" placeholder="30">

    <br><br>

    <button id="crear-geocerca">Activar creaci√≥n</button>

    <p style="color:#444; font-size:14px; margin-top:10px;">
      Despu√©s de activar, toca en el mapa donde quieras crear la geocerca.
    </p>
  </div>

  <!-- Notificaci√≥n -->
  <div id="noti"></div>

  <!-- Nuevo sonido (m√°s fuerte / moderno) -->
  <audio id="alerta-sonido">
    <source src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_0e9e19794c.mp3?filename=warning-alarm-108482.mp3" type="audio/mpeg">
  </audio>

  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>

  <script type="module">

    /* -------------------- FIREBASE -------------------- */

    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-analytics.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCtcCm1fQw2-l0MZo7BnwDk3R_1IO5sr2k",
      authDomain: "mapa-79fbf.firebaseapp.com",
      databaseURL: "https://mapa-79fbf-default-rtdb.firebaseio.com",
      projectId: "mapa-79fbf",
      storageBucket: "mapa-79fbf.firebasestorage.app",
      messagingSenderId: "765682241790",
      appId: "1:765682241790:web:f6efeeb7a1ce81682415af",
      measurementId: "G-8C0P05RTLK"
    };

    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const db = getDatabase(app);

    /* -------------------- MAPBOX -------------------- */

    mapboxgl.accessToken =
    'pk.eyJ1IjoiY2hleHhvbyIsImEiOiJjbWltenZhOWUwbmhzM2ZwdTBldHBpbHE3In0.1fqGI7mnI4IjyAqKNtW-dQ';

    window.onload = () => {

      const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/streets-v11',
        center: [-68.1193, -16.5000],
        zoom: 13
      });

      map.addControl(new mapboxgl.NavigationControl());

      /* VARIABLES */
      let geofenceCenter = [-68.1199976, -16.5036126];
      let geofenceRadius = 30;
      let modoCrear = false;

      /* NOTIFICACI√ìN */
      function notificar(msg) {
        const n = document.getElementById("noti");
        n.textContent = msg;
        n.style.opacity = "1";
        n.style.transform = "translateY(0)";

        setTimeout(() => {
          n.style.opacity = "0";
          n.style.transform = "translateY(-20px)";
        }, 2500);
      }

      /* C√çRCULO */
      function generarCirculo([lng, lat], radio, puntos = 64) {
        const coords = [];
        for (let i = 0; i < puntos; i++) {
          const ang = i * 2 * Math.PI / puntos;
          const dx = radio * Math.cos(ang);
          const dy = radio * Math.sin(ang);
          const dLng = dx / (111320 * Math.cos(lat * Math.PI / 180));
          const dLat = dy / 110540;
          coords.push([lng + dLng, lat + dLat]);
        }
        coords.push(coords[0]);
        return coords;
      }

      map.on('load', () => {

        map.addSource('geofence', {
          type: 'geojson',
          data: {
            type: "Feature",
            geometry: {
              type: "Polygon",
              coordinates: [generarCirculo(geofenceCenter, geofenceRadius)]
            }
          }
        });

        map.addLayer({
          id: 'geofence-fill',
          type: 'fill',
          source: 'geofence',
          paint: {
            'fill-color': 'rgba(180,0,255,0.25)',
            'fill-outline-color': '#6A00B9'
          }
        });

        /* Activar creaci√≥n */
        document.getElementById("crear-geocerca").onclick = () => {
          const rad = parseFloat(document.getElementById("geo-rad").value);

          if (isNaN(rad)) {
            notificar("‚ùå Radio inv√°lido");
            return;
          }

          geofenceRadius = rad;
          modoCrear = true;
          notificar("üìç Toca en el mapa para crear la geocerca");
        };

        /* Crear geocerca */
        map.on("click", (e) => {
          if (!modoCrear) return;

          geofenceCenter = [e.lngLat.lng, e.lngLat.lat];

          map.getSource("geofence").setData({
            type: "Feature",
            geometry: {
              type: "Polygon",
              coordinates: [generarCirculo(geofenceCenter, geofenceRadius)]
            }
          });

          modoCrear = false;

          notificar("üí† Geocerca creada correctamente");
        });

      });

      /* DISTANCIA */
      function distanciaMetros(lat1, lon1, lat2, lon2) {
        const R = 6371000;
        const toRad = x => x * Math.PI / 180;
        const dLat = toRad(lat2 - lat1);
        const dLon = toRad(lon2 - lon1);
        const a = Math.sin(dLat/2)**2 +
                  Math.cos(toRad(lat1))*Math.cos(toRad(lat2)) *
                  Math.sin(dLon/2)**2;
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
      }

      /* UBICACI√ìN EN TIEMPO REAL */
      let marker = null;
      const deviceId = "7677086aaad7e9f9";
      const ubicacionRef = ref(db, `Ubicaciones/${deviceId}`);

      onValue(ubicacionRef, (snapshot) => {
        const data = snapshot.val();
        if (!data) return;

        const lat = parseFloat(data.latitud);
        const lon = parseFloat(data.longitud);

        if (!isNaN(lat) && !isNaN(lon)) {

          if (!marker) {
            marker = new mapboxgl.Marker({ color: 'purple' })
            .setLngLat([lon, lat])
            .addTo(map);

            map.setCenter([lon, lat]);
          }
          else {
            marker.setLngLat([lon, lat]);
          }

          document.getElementById("id").textContent = data.idDispositivo || "Desconocido";
          document.getElementById("lat").textContent = lat.toFixed(5);
          document.getElementById("lon").textContent = lon.toFixed(5);
          document.getElementById("hora").textContent = data.hora || "--";

          const distancia = distanciaMetros(lat, lon, geofenceCenter[1], geofenceCenter[0]);

          if (distancia > geofenceRadius) {
            document.getElementById("estado").textContent = "üî¥ Fuera de la geocerca";
            document.getElementById("estado").className = "estado-rojo";

            document.getElementById("alerta-sonido").play();

            notificar("üö® Alerta: saliste de la geocerca");
          }
          else {
            document.getElementById("estado").textContent = "üü¢ Dentro de la geocerca";
            document.getElementById("estado").className = "estado-verde";
          }
        }
      });

    };

  </script>

</body>
</html>
