<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Proyecto Geocercas â€“ Jessica Lafuente</title>

<!-- MAPBOX -->
<script src="https://api.mapbox.com/mapbox-gl-js/v2.16.0/mapbox-gl.js"></script>
<link href="https://api.mapbox.com/mapbox-gl-js/v2.16.0/mapbox-gl.css" rel="stylesheet" />

<style>
    /* ======= TEMA COMPLETO ROSADO ======= */
    body {
        background: #ffe4f6;
        margin: 0;
        font-family: 'Poppins', sans-serif;
    }

    header {
        background: #b800aa;
        padding: 20px;
        text-align: center;
        color: white;
        font-size: 30px;
        font-weight: 700;
        box-shadow: 0 3px 10px rgba(0,0,0,0.2);
    }

    /* ======= BARRA SUPERIOR DE ALERTA ======= */
    #geofenceAlert {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        padding: 15px 20px;
        color: white;
        font-size: 18px;
        font-weight: bold;
        text-align: center;
        z-index: 9999;
        display: none;
        border-radius: 0 0 12px 12px;
        box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        animation: fadeIn 0.4s ease-in-out;
    }

    .alert-inside {
        background: #ff8fd1;
    }

    .alert-outside {
        background: #ff3366;
        animation: shake 0.5s ease-in-out;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to   { opacity: 1; transform: translateY(0); }
    }

    @keyframes shake {
        0% { transform: translateX(0); }
        25% { transform: translateX(-5px); }
        50% { transform: translateX(5px); }
        75% { transform: translateX(-5px); }
        100% { transform: translateX(0); }
    }

    /* ======= MAPA ======= */
    #map {
        width: 90%;
        height: 500px;
        border-radius: 20px;
        margin: 40px auto;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    /* Marcador rosado */
    .pink-marker {
        background-color: #ff2faf;
        width: 22px;
        height: 22px;
        border-radius: 50%;
        border: 3px solid white;
        box-shadow: 0 0 10px rgba(255,20,147,0.8);
    }

    /* Panel datos usuario */
    .panel {
        width: 90%;
        background: white;
        padding: 20px;
        margin: 20px auto;
        border-radius: 20px;
        box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        font-size: 18px;
        color: #b800aa;
        line-height: 28px;
    }

</style>
</head>

<body>

<header>PROYECTO GEOCERCAS â€“ JESSICA LAFUENTE</header>

<!-- ALERTA SUPERIOR -->
<div id="geofenceAlert"></div>

<!-- MAPA -->
<div id="map"></div>

<!-- INFO -->
<div class="panel">
    <b>ID:</b> <span id="uid"></span><br>
    <b>Latitud:</b> <span id="lat"></span><br>
    <b>Longitud:</b> <span id="lng"></span><br>
</div>

<script>
// ==================== MAPBOX ====================
mapboxgl.accessToken = "TU_TOKEN_AQUI";

const map = new mapboxgl.Map({
    container: "map",
    style: "mapbox://styles/mapbox/streets-v12",
    center: [-68.1193, -16.5000],
    zoom: 12
});

// ====== MARCADOR ROSADO ======
const markerEl = document.createElement("div");
markerEl.className = "pink-marker";

const marker = new mapboxgl.Marker(markerEl)
    .setLngLat([-68.1193, -16.5000])
    .addTo(map);

// ====== GEOCERCA (CÃRCULO ROSADO) ======
const geofenceCenter = [-68.1193, -16.503];
const geofenceRadius = 300; // metros

map.on("load", () => {
    map.addSource("geofence", {
        type: "geojson",
        data: crearGeocerca()
    });

    map.addLayer({
        id: "geofence-fill",
        type: "fill",
        source: "geofence",
        paint: {
            "fill-color": "#ff7ac4",
            "fill-opacity": 0.3
        }
    });

    map.addLayer({
        id: "geofence-outline",
        type: "line",
        source: "geofence",
        paint: {
            "line-color": "#ff1e88",
            "line-width": 3
        }
    });
});

// Crear cÃ­rculo en GeoJSON
function crearGeocerca() {
    const points = 64;
    const coords = [];

    for (let i = 0; i < points; i++) {
        const angle = (i * 360 / points) * (Math.PI / 180);
        coords.push([
            geofenceCenter[0] + (geofenceRadius / 111320) * Math.cos(angle),
            geofenceCenter[1] + (geofenceRadius / 111320) * Math.sin(angle)
        ]);
    }

    coords.push(coords[0]);

    return {
        type: "Feature",
        geometry: {
            type: "Polygon",
            coordinates: [coords]
        }
    };
}

// ========== ALERTA DE GEOCERCA ==========
function actualizarAlertaGeocerca(inside) {
    const alertBar = document.getElementById("geofenceAlert");

    if (inside) {
        alertBar.innerHTML = "ðŸ’– EstÃ¡s dentro de la geocerca";
        alertBar.className = "alert-inside";
        alertBar.style.display = "block";
    } else {
        alertBar.innerHTML = "ðŸš¨ EstÃ¡s FUERA de la geocerca";
        alertBar.className = "alert-outside";
        alertBar.style.display = "block";
    }
}

// ==================== UBICACIÃ“N EN VIVO ====================
navigator.geolocation.watchPosition(
    pos => {
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;

        document.getElementById("lat").innerText = lat;
        document.getElementById("lng").innerText = lng;

        marker.setLngLat([lng, lat]);

        const dist = calcularDistancia(lat, lng, geofenceCenter[1], geofenceCenter[0]);

        actualizarAlertaGeocerca(dist <= geofenceRadius);
    },
    err => console.log(err),
    { enableHighAccuracy: true }
);

// Distancia entre dos coordenadas (metros)
function calcularDistancia(lat1, lon1, lat2, lon2) {
    const R = 6371000;
    const dLat = (lat2 - lat1) * Math.PI/180;
    const dLon = (lon2 - lon1) * Math.PI/180;
    const a =
        Math.sin(dLat/2) ** 2 +
        Math.cos(lat1*Math.PI/180) *
        Math.cos(lat2*Math.PI/180) *
        Math.sin(dLon/2) ** 2;

    return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)));
}
</script>

</body>
</html>
